const __emojis_weibo = {
  "广告":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/ad_new0902_thumb.gif",
  "doge":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/doge_thumb.gif",
  "喵喵": "http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/4a/mm_thumb.gif",
  "二哈": "http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/74/moren_hashiqi_thumb.png",
  "鼓掌":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/36/gza_thumb.gif",
  "小黄人剪刀手":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ed/xiaohuangren_jiandaoshou_thumb.png",
  "小黄人高兴":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8d/xiaohuangren_gaoxing_thumb.png",
  "笑cry": "http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/34/xiaoku_thumb.gif",
  "摊手":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/09/pcmoren_tanshou_thumb.png",
  "抱抱":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/pcmoren_baobao_thumb.png",
  "跪了":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6c/pcmoren_guile_thumb.png",
  "吃瓜":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8a/moren_chiguaqunzhong_thumb.png",
  "哆啦A梦吃惊":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f0/dorachijing_thumb.gif",
  "坏笑":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/50/pcmoren_huaixiao_thumb.png",
  "舔屏":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/pcmoren_tian_thumb.png",
  "污":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/pcmoren_wu_thumb.png",
  "允悲":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/2c/moren_yunbei_thumb.png",
  "笑而不语":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3a/moren_xiaoerbuyu_thumb.png",
  "费解":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3c/moren_feijie_thumb.png",
  "憧憬":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/37/moren_chongjing_thumb.png",
  "并不简单":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/fc/moren_bbjdnew_thumb.png",
  "微笑":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/huanglianwx_thumb.gif",
  "酷":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8a/pcmoren_cool2017_thumb.png",
  "嘻嘻":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/tootha_thumb.gif",
  "哈哈":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6a/laugh.gif",
  "可爱":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/14/tza_thumb.gif",
  "可怜":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/kl_thumb.gif",
  "挖鼻":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0b/wabi_thumb.gif",
  "吃惊":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f4/cj_thumb.gif",
  "害羞":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/shamea_thumb.gif",
  "挤眼":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/c3/zy_thumb.gif",
  "闭嘴":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/29/bz_thumb.gif",
  "鄙视":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/71/bs2_thumb.gif",
  "爱你":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/lovea_thumb.gif",
  "愛你":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/lovea_thumb.gif",
  "泪":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9d/sada_thumb.gif",
  "偷笑":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/19/heia_thumb.gif",
  "亲亲":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/8f/qq_thumb.gif",
  "生病":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/b6/sb_thumb.gif",
  "太开心":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/mb_thumb.gif",
  "白眼":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/landeln_thumb.gif",
  "右哼哼":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/98/yhh_thumb.gif",
  "左哼哼":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/zhh_thumb.gif",
  "嘘":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a6/x_thumb.gif",
  "衰":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/af/cry.gif",
  "委屈":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/73/wq_thumb.gif",
  "吐":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9e/t_thumb.gif",
  "哈欠":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/cc/haqianv2_thumb.gif",
  "抱抱_旧":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/27/bba_thumb.gif",
  "怒":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7c/angrya_thumb.gif",
  "疑问":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/5c/yw_thumb.gif",
  "馋嘴":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/a5/cza_thumb.gif",
  "拜拜":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/88_thumb.gif",
  "思考":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/e9/sk_thumb.gif",
  "汗":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/24/sweata_thumb.gif",
  "困":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/kunv2_thumb.gif",
  "睡":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/96/huangliansj_thumb.gif",
  "钱":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/90/money_thumb.gif",
  "失望":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/0c/sw_thumb.gif",
  "色":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/20/huanglianse_thumb.gif",
  "哼":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/49/hatea_thumb.gif",
  "鼓掌":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/36/gza_thumb.gif",
  "晕":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/dizzya_thumb.gif",
  "悲伤":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1a/bs_thumb.gif",
  "抓狂":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/62/crazya_thumb.gif",
  "黑线":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/91/h_thumb.gif",
  "阴险":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6d/yx_thumb.gif",
  "怒骂":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/numav2_thumb.gif",
  "互粉":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/89/hufen_thumb.gif",
  "心":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/hearta_thumb.gif",
  "伤心":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ea/unheart.gif",
  "猪头":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/58/pig.gif",
  "熊猫":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/6e/panda_thumb.gif",
  "兔子":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/81/rabbit_thumb.gif",
  "ok":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d6/ok_thumb.gif",
  "耶":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d9/ye_thumb.gif",
  "good":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/good_thumb.gif",
  "NO":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/ae/buyao_org.gif",
  "赞":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d0/z2_thumb.gif",
  "来":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/40/come_thumb.gif",
  "弱":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/d8/sad_thumb.gif",
  "草泥马":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/7a/shenshou_thumb.gif",
  "神马":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/60/horse2_thumb.gif",
  "囧":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/15/j_thumb.gif",
  "浮云":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/bc/fuyun_thumb.gif",
  "给力":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/1e/geiliv2_thumb.gif",
  "围观":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/f2/wg_thumb.gif",
  "威武":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/70/vw_thumb.gif",
  "话筒":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/9f/huatongv2_thumb.gif",
  "蛋糕":"http://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/3a/cakev2_thumb.gif",
}


const wechat_root = "http://oi2auui73.bkt.clouddn.com/emojis/wechat/"
var __emojis_wechat = {
  "微笑": "smile",
  "撇嘴":"grimance",
  "色":"drool",
  "发呆":"scowl",
  "得意":"cool_guy",
  "流泪":"sob",
  "害羞":"shy",
  "闭嘴":"silent",
  "睡":"sleep",
  "大哭":"cry",
  "尴尬":"awkward",
  "发怒":"angry",
  "调皮":"tongue",
  "呲牙":"grin",
  "惊讶":"surprise",
  "难过":"frown",
  "酷":"ruthless",
  "冷汗":"blush",
  "抓狂":"scream",
  "吐":"puke",
  "偷笑":"chuckle",
  "愉快":"joyful",
  "白眼":"slight",
  "傲慢":"smug",
  "饥饿":"hungry",
  "困":"drowsy",
  "惊恐":"panic",
  "流汗":"sweat",
  "憨笑":"laugh",
  "悠闲":"commando",
  "奋斗":"determined",
  "咒骂":"scold",
  "疑问":"shocked",
  "嘘":"shhh",
  "晕":"dizzy",
  "疯了":"tormented",
  "衰":"toasted",
  "骷髅":"skull",
  "敲打":"hammer",
  "再见":"wave",
  "擦汗":"speechless",
  "抠鼻":"nosepick",
  "鼓掌":"clap",
  "糗大了":"shame",
  "坏笑":"trick",
  "左哼哼":"bah_l",
  "右哼哼":"bah_r",
  "哈欠":"yawn",
  "鄙视":"pooh_pooh",
  "委屈":"shrunken",
  "快哭了":"tearing_up",
  "阴险":"sly",
  "亲亲":"kiss",
  "吓":"wrath",
  "可怜":"whimper",
  "菜刀":"cleaver",
  "西瓜":"watermelon",
  "啤酒":"beer",
  "篮球":"basketball",
  "兵乓":"ping_pong",
  "咖啡":"coffee",
  "饭":"rice",
  "猪头":"pig",
  "玫瑰":"rose",
  "凋谢":"wilt",
  "嘴唇":"lips",
  "爱心":"heart",
  "心碎":"broken_heart",
  "蛋糕":"cake",
  "闪电":"lightning",
  "炸弹":"bomb",
  "刀":"dagger",
  "足球":"soccer",
  "瓢虫":"ladybug",
  "便便":"poop",
  "月亮":"moon",
  "太阳":"sun",
  "礼物":"gift",
  "拥抱":"hug",
  "强":"thumbs_up",
  "弱":"thumbs_down",
  "握手":"shake",
  "胜利":"peace",
  "抱拳":"fight",
  "勾引":"beckon",
  "拳头":"fist",
  "差劲":"pinky",
  "爱你":"rock_on",
  "NO":"nuh_uh",
  "OK":"ok",
  "爱情":"in_love",
  "飞吻":"blowkiss",
  "跳跳":"waddle",
  "发抖":"tremble",
  "怄火":"aaagh",
  "转圈":"twirl",
  "磕头":"kotow",
  "回头":"dramatic",
  "跳绳":"jump_rope",
  "头像":"surrender",
  "hooray":"hooray",
  "meditate":"meditate",
  "smooch":"smooch",
  "taichil":"taichi_l",
  "taichir":"taichi_r"
}
for (let key in __emojis_wechat){
  __emojis_wechat[key] = wechat_root + __emojis_wechat[key] + '.png'
}


const __emojisBaseSrc = ""
const formatTime = (date, hasTime) => {
  const year = date.getFullYear()
  const month = date.getMonth() + 1
  const day = date.getDate()
  const hour = date.getHours()
  const minute = date.getMinutes()
  const second = date.getSeconds()

  return hasTime ? [year, month, day].map(formatNumber).join('.') + ' ' + [hour, minute].map(formatNumber).join(':') : [year, month, day].map(formatNumber).join('.')
}


const formatNumber = n => {
  n = n.toString()
  return n[1] ? n : '0' + n
}

module.exports = {

  weiboEmojis: __emojis_weibo,
  wechatEmojis: __emojis_wechat,

  // 格式化时间
  formatTime: formatTime,

  // 深拷贝
  cloneDeep: function copy(o) {
    var _out, v, _key;
    _out = Array.isArray(o) ? [] : {};
    for (_key in o) {
      v = o[_key];
      _out[_key] = (typeof v === "object") ? copy(v) : v;
    }
    return _out;
  },


  // 抽取HTML内文字内容
  extractContent: function(value) {
    return value.replace(/<[^>]*>/g, "").replace(/[\r\n]/g, "").replace(/&nbsp;/g," ");
    // return (new DOMParser).parseFromString(value, "text/html").documentElement.textContent.replace(/[\r\n]/g, "");
  },

  // 格式化统计数据
  formatStats: function(stats){
    for(let key in stats){
      stats[key] = parseFloat(stats[key]).toLocaleString();
    }
    return stats;
  },


  // 处理文字 新
  parseRichTxt: function (str, postType){
    let wrapMarks = [];
    let __emojis = postType === 'weibo' ? __emojis_weibo : __emojis_wechat
    str.replace(/#([^#]*)#/g, (k, text) => {
      wrapMarks.push(text);
    });

    let emojiMarks = [];
    str.replace(/\[([^\[\]]*)\]/g, (k, text) => {
      emojiMarks.push(text);
    }); 

    let atMarks = []; // @xxx+空格 @xxx+结尾
    // 匹配中英文、数字、下划线、减号
    str.replace(/(@[\u4e00-\u9fa5_a-zA-Z0-9\-]+)/g,(k, text)=>{
      atMarks.push(text)
    })
  
    // console.log(atMarks)
    // "@123？ @12 ".replace(/@(.+)[\s|\u3002|\uff1b|\uff0c|\uff1a|\u201c|\u201d|\uff08|\uff09|\u3001|\uff1f|\u300a|\u300b]{1}/g, function(text,v2){console.log(text,v2)})

    str = str.replace(/\[([^\[\]]+)\]/g, '_$1_')
    str = str.replace(/(@[\u4e00-\u9fa5_a-zA-Z0-9\-]+)/g,'_$1_')
   

    var eReg = new RegExp("[_#]");
    var array = str.split(eReg);
    
    let emojiObjs = [];

    for (var i = 0; i < array.length; i++) {
      var ele = array[i];
      var emojiObj = {};
      if (__emojis[ele]) {
        emojiObj.node = "emoji";
        emojiObj.src = __emojisBaseSrc + __emojis[ele];
      } else if (emojiMarks.indexOf(ele) > -1){
        emojiObj.node = "text";
        emojiObj.text = '[' + ele + ']';
      } else if (wrapMarks.indexOf(ele) > -1){
        emojiObj.node = "topic";
        emojiObj.text = ele;
      } else if(atMarks.indexOf(ele) > -1){
        emojiObj.node = "at";
        emojiObj.text = ele;
      } else {
        emojiObj.node = "text";
        emojiObj.text = ele;
      }

      emojiObjs.push(emojiObj);
    }

    return emojiObjs;
  },

  // 处理文字 旧
  parseText: function(text){
    let regResult = [];
    let nodes = [];
    let pos = 0;
    let arrIndex = 0;

    text.replace(/(#[^#]*#)/g, (k, text,idx) => {
      regResult.push({
        text: text,
        index:idx
      });
    });


    while (arrIndex < regResult.length){
      let str1 = text.substr(pos, regResult[arrIndex].index - pos);
      pos += str1.length;
      let str2 = text.substr(pos, regResult[arrIndex].text.length);
      pos += str2.length;

      nodes.push({
        text: str1,
        class: ''
      });
      nodes.push({
        text: str2,
        class:'fa-blue'
      })
     
      arrIndex += 1;
    }

    nodes.push({
      text: text.substr(pos, text.length - pos),
      class:''
    });

    return nodes;
  },

  // 格式化案例列表
  formatCaseList(caseList){

    if (Array.isArray(caseList)){
      
      caseList = caseList.map((v) => {

        v.timeString = this.formatTime(new Date(v.createdAt));
        v.createdDate = +new Date(v.createdAt);
        v.stats = this.formatStats(v.stats);
        
        // 默认微信
        v.fromTitle = "微信"
        v.fromUrl = "/image/wechat-logo.png"

        // 默认空描述
        v.parsedDesc = []

        v.descClass = 'bt-2line'
        v.id = v.id || v._id


        v.account.logo = v.account.logo.path
        v.brand = v.brand || {}
        if(Array.isArray(v.brands) && v.brands.length){
          v.brand.logo = v.brands[0].logo.path
        }

        v.weiboClass = ""
        
        
        if (v.postType === 'weibo') {
          v.parsedDesc = this.parseRichTxt(v.title, v.postType);
          v.fromTitle = "微博";
          v.fromUrl = "/image/weibo-logo.png";
          v.isVideoType = ((v.media || []).indexOf('video')) > -1;
          v.weiboClass = v.isVideoType ? "list-item__thumb--weibovideo" : "list-item__thumb--weiboimg";
          
        } else if(v.postType === 'wechat'){
          v.parsedDesc = this.parseRichTxt(v.summary);
          v.descClass = 'bt-2line fa-mt5';
        } else if(v.postType === 'zhihu'){
          v.fromTitle = "知乎";
          v.fromUrl = "/image/zhihu-logo.png";
        }
        return v;
      })

      caseList.sort(function (v1, v2) {
        return v2.createdDate - v1.createdDate;
      })

      return caseList

    } else {
      return []
    }
  }
}
